[gcode_macro FILAMENT_USAGE]
variable_pause: 1.0
gcode:
    {% set filament_type = None %}
    {% set filament_density = 1.0 %}  # densité par défaut pour les filaments inconnus
    {% for cmd in gcode_commands -%}
        {% if cmd.gcode == "M109" -%}
            {% set cmd_args = cmd.params.split(' ') %}
            {% for arg in cmd_args -%}
                {% if arg.startswith("using") -%}
                    {% set filament_type = arg.split(' ')[1].lower() %}
                {% endif -%}
            {% endfor -%}
        {% elif cmd.gcode == "M190" -%}
            {% set cmd_args = cmd.params.split(' ') %}
            {% for arg in cmd_args -%}
                {% if arg.startswith("using") -%}
                    {% set filament_type = arg.split(' ')[1].lower() %}
                {% endif -%}
            {% endfor -%}
        {% endif -%}
    {% endfor -%}
    
    {% if filament_type == "pla" %}
        {% set filament_density = 1.24 %}
    {% elif filament_type == "abs" %}
        {% set filament_density = 1.04 %}
    {% elif filament_type == "petg" %}
        {% set filament_density = 1.27 %}
    {% endif %}
    
    {% set filament_weight = filament_density * filament_length * cross_sectional_area / 1000 %}
    {% set filament_used = filament_weight - filament_weight_start %}
    
    M117 "Filament used: {{filament_used:.2f}}g / {{filament_weight:.2f}}g"
