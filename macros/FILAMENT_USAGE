[gcode_macro FILAMENT_USAGE]
variable_weight: 1.0     # Poids de la bobine en kg (par défaut = 1.0)
variable_density: 1.0    # Densité du filament en g/cm^3 (par défaut = 1.0)
gcode:
    {% set current_extruder = params.tool | default(0) %}
    {% set current_filament_usage = printer.filament_used[current_extruder] %}
    {% set filament_used = 0.0 %}
    
    # Parse through the file and add up filament usage
    {% for cmd in gcode_commands -%}
        {% if cmd.gcode == "G1" and "E" in cmd.params -%}
            {% set e_val = cmd.params.E | float %}
            {% set filament_used = filament_used + e_val -%}
        {% endif -%}
    {% endfor -%}
    
    # Calculate the filament mass and add it to the total used
    {% set filament_mass = (filament_used / 1000.0) * variable_density %}
    {% set new_filament_usage = current_filament_usage + filament_mass %}
    {% set printer.filament_used[current_extruder] = new_filament_usage %}
    
    # Calculate the percentage of filament used based on the weight of the spool
    {% set spool_weight = variable_weight - new_filament_usage %}
    {% set percent_used = (new_filament_usage / variable_weight) * 100 %}
    
    # Display the filament usage on the printer screen
    M117 "Filament used: {{ filament_used }}mm | Mass used: {{ filament_mass }}g | Spool weight: {{ spool_weight }}kg | Percent used: {{ percent_used }}%"
